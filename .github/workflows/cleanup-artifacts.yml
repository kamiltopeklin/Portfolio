name: Cleanup Old Artifacts

on:
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  actions: write  # Required to delete artifacts

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            console.log(`Found ${artifacts.data.artifacts.length} total artifacts`);
            
            let deletedCount = 0;
            for (const artifact of artifacts.data.artifacts) {
              // Delete all artifacts named "github-pages" (except keep the most recent one)
              if (artifact.name === 'github-pages') {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
                console.log(`Deleted artifact: ${artifact.name} (ID: ${artifact.id}, Created: ${artifact.created_at})`);
                deletedCount++;
              }
            }
            
            console.log(`Deleted ${deletedCount} artifacts`);
            
            if (deletedCount === 0) {
              console.log('No artifacts to delete');
            }
