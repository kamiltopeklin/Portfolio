name: Cleanup Old Artifacts

on:
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  actions: write  # Required to delete artifacts

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete ALL old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Starting artifact cleanup...');
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            console.log(`Found ${artifacts.data.artifacts.length} total artifacts in repository`);
            
            const githubPagesArtifacts = artifacts.data.artifacts.filter(
              artifact => artifact.name === 'github-pages'
            );
            
            console.log(`Found ${githubPagesArtifacts.length} "github-pages" artifacts`);
            
            if (githubPagesArtifacts.length === 0) {
              console.log('No "github-pages" artifacts to delete');
              return;
            }
            
            // Sort by creation date (oldest first) to delete oldest first
            githubPagesArtifacts.sort((a, b) => 
              new Date(a.created_at) - new Date(b.created_at)
            );
            
            let deletedCount = 0;
            let failedCount = 0;
            
            // Delete ALL artifacts (we'll let the next build create a fresh one)
            for (const artifact of githubPagesArtifacts) {
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
                console.log(`✓ Deleted artifact: ${artifact.name} (ID: ${artifact.id}, Created: ${artifact.created_at})`);
                deletedCount++;
              } catch (error) {
                console.log(`✗ Failed to delete artifact ${artifact.id}: ${error.message}`);
                failedCount++;
              }
            }
            
            console.log(`\nCleanup complete:`);
            console.log(`  - Deleted: ${deletedCount} artifacts`);
            console.log(`  - Failed: ${failedCount} artifacts`);
            
            if (deletedCount > 0) {
              console.log('\n✓ All old artifacts have been deleted. The next deployment will create a fresh artifact.');
            }
